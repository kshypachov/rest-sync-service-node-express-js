# Розгортання вебсрвісу в Docker

## Вимоги

| ПЗ             |   Версія   | Примітка                     |
|:---------------|:----------:|------------------------------|
| MariaDB        | **10.5+**  |                              |
| Docker         | **20.10+** |                              |
| Docker Compose |   10.5+    | Якщо планується використання |
| Git            |            | Для клонування репозиторію   |

## Змінні оточення

Вебсервіс підтримує конфігурацію через змінні оточення.

Нижче наведено основні параметри:

- `PORT`: Порт, на якому буде запущено сервер
- `DB_USER`: Ім'я користувача бази даних.
- `DB_PASSWORD`: Пароль для підключення до бази даних.
- `DB_HOST`: Адреса хоста бази даних.
- `DB_NAME`: Ім'я бази даних.
- `LOG_FILENAME`: Ім'я файлу для логування. Якщо передано порожнє значення, логи будуть виводитися в консоль (stdout).
- `LOG_LEVEL`: Рівень логування (наприклад, `info`, `debug`).
- `LOG_FILEMODE`: Режим роботи з логами (наприклад, `a` — додавання до існуючого файлу або `w` — перезапис).

## Збір Docker-образу

Для того, щоб зібрати Docker-образ, необхідно:

1. Клонувати репозиторій:

```bash
git clone https://github.com/kshypachov/rest-sync-service-node-express-js.git
```

2. Перейти до директорії з вебсервісом:
```bash
cd rest-sync-service-node-express-js
```

3. Виконати наступну команду в кореневій директорії проєкту:

```bash
sudo docker build -t my-js-service-app .
```

Дана команда створить Docker-образ з іменем `my-js-service-app`, використовуючи Dockerfile, який знаходиться в поточній директорії.

## Створення бази даних для сервісу
Хоча контейнер і має у своєму складі компонент alembic котрий може створювати структуру бази даних, але його запуск з контейнера не є зручним.
Саме тому пропонується створити базу даних та її структуру вручну.

Для створення бази даних та її структури необхідно:
1. Встановити СУБД MariaDB згідно настанов пунктів 2-5 [настанов з ручного встановлення вебсервісу](./manual_installation.md#2-додати-репозиторій-mariadb).

2. Створити базу даних та користувача настанов пункту 6 [настанов з ручного встановлення вебсервісу](./manual_installation.md#6-створити-базу-даних-та-користувача-для-цього-необхідно).

## Запуск та використання контейнера зі змінними оточення

Щоб запустити контейнер з вебсервісом, необхідно виконати наступну команду:

```bash
docker run -it --rm -p 3000:3000 \
    -e DB_USER=myuser \
    -e DB_PASSWORD=mypassword \
    -e DB_HOST=mydbhost \
    -e DB_NAME=mydatabase \
    -e LOG_LEVEL=info \
    -e PORT=3000 \
     my-js-service-app
```
де:
- параметр `-p 3000:3000` перенаправляє порт 3000 на локальній машині на порт 3000 всередині контейнера.
- `DB_USER`: Ім'я користувача бази даних.
- `DB_PASSWORD`: Пароль для підключення до бази даних.
- `DB_HOST`: Адреса хоста бази даних.
- `DB_NAME`: Назва бази даних.
- змінна `LOG_FILENAME=""` задає виведення логів у консоль (stdout).

**Примітка:** У випадку розташування бази даних на одному хості з вебсервісом в значенні параметра `DB_HOST` необхідно вказувати IP-адресу хоста, значення `localhost` або `127.0.0.1` працювати не будуть. Окрім цього необхідно налаштувати зовнішні підключення до бази даних

## Перегляд журналыв подій

Якщо виведення журналів подій налаштоване у консоль, переглядати їх можна за допомогою команди:

```bash
docker logs <container_id>
```

В разі, якщо журнали подій зберігаються у файл (через змінну оточення `LOG_FILENAME` або конфігураційний файл), можна налаштувати монтування директорії з журналами подій на локальній машині наступним чином:

```bash
docker run -it --rm -p 3000:3000 \
    -e LOG_FILENAME="/var/log/app.log" \
    -v $(pwd)/logs:/var/log \
    my-js-service-app
```

де параметр `-v $(pwd)/logs:/var/log` монтує локальну директорію для збереження логів.

##
Матеріали створено за підтримки проєкту міжнародної технічної допомоги «Підтримка ЄС цифрової трансформації України (DT4UA)».
